/* jQuery PageGuide Plugin Copyright 2012 Sprint.ly Author: Ian White <ian@sprint.ly> Source: http://github.com/impressiver/jquery.pageguide Free to use under the MIT license. Based on: Tracelytics PageGuide Copyright 2012 Tracelytics Project Home: http://tracelytics.github.com/pageguide/ Free to use under the MIT license. http://www.opensource.org/licenses/mit-license.php */
(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory);}else{factory(jQuery);}}(function($,undefined){if($.pageguide!==undefined){return;}var PageGuide=function(guide,options){if(arguments.length==1){options=guide;guide=null;}options=options||{};this.options(options);if(!$.fn.zIndex){$.fn.zIndex=this._zIndex;}this.init();var defaultGuide=guide||this.settings.defaultGuide||null;if(defaultGuide){if(this.status==="ready"){this.load(defaultGuide);}else{this.$wrapper.one("ready.pageguide",$.proxy(function(){this.load(defaultGuide);},this));}}};$.extend(PageGuide,{options:{defaultGuide:"#pageGuide",autoStart:true,autoStartDelay:0,autoAdvanceInterval:null,loadingSelector:null,pulse:true,events:{},step:{direction:"left",margin:{top:100,bottom:100},shadow:true,shadowPadding:"10px",zIndex:null,arrow:{offsetX:0,offsetY:0},events:{}}},DIRECTION_REGEX:/pageguide[_-](top|right|bottom|left)(?:\s|$)/i,instances:0,uid:function(){return PageGuide.instances++;},prototype:{_options:{},settings:{},status:"uninitialized",_guide:null,$guide:null,$wrapper:null,$message:null,$toggle:null,$shadow:null,$fwd:null,$back:null,init:function(){var wrapper=$("<div>",{id:"pageGuideWrapper"}),message=$("<div>",{id:"pageGuideMessage"}),toggle=$("<div/>",{id:"pageGuideToggle",title:"Launch Page Guide","class":"pageguide-toggle-close"}),shadow=$("<div/>",{id:"pageGuideShadow","class":"pageguide-shadow"});toggle.append("page guide").append('<div><span class="pageguide-tourtitle"></span></div>').append('<a class="pageguide-close" title="Close Guide">close guide &raquo;</a>');message.append('<a class="pageguide-close" title="Close Guide">close</a>').append('<span class="pageguide-index"></span>').append('<div class="pageguide-content"></div>').append('<a class="pageguide-back" title="Previous">Previous</a>').append('<a class="pageguide-fwd" title="Next">Next</a>');shadow.append('<span class="pageguide-shadow-pulse"></span>');wrapper.append(toggle);wrapper.append(message);wrapper.append(shadow);$("body").append(wrapper);this.$wrapper=wrapper;this.$toggle=toggle;this.$message=message;this.$shadow=shadow;this.$fwd=$("a.pageguide-fwd",this.$wrapper);this.$back=$("a.pageguide-back",this.$wrapper);this.status="initialized";this.$wrapper.trigger("init.pageguide");if(this.settings.loadingSelector){this._wait($.proxy(function(){this._registerWrapperHandlers();this.status="ready";this.$wrapper.trigger("ready.pageguide");},this));}else{this._registerWrapperHandlers();this.status="ready";this.$wrapper.trigger("ready.pageguide");}},destroy:function(){if(this._guide){this.unload();}this._removeWrapperHandlers();this.$wrapper.remove();this.status="destroyed";return this;},options:function(options){if(options===undefined){return this._options;}this._options=$.extend(true,{},PageGuide.options,options);this.settings=$.extend(true,{},PageGuide.options,this.settings||{},options);return this;},guide:function(guide){if(guide===undefined){return this._guide;}this.load(guide,this.settings);return this;},load:function(guide,options){if(!guide||$.isEmptyObject(guide)){return this;}if(this._guide){this.unload();}if(options!==undefined){this.settings=$.extend(true,{},PageGuide.options,this._options,options);}var that=this,$guide=(typeof guide==="string")?$(guide):null;if($guide){if(!$guide.size()){return this;}guide={title:$guide.data("tourtitle"),steps:[]};var $allItems=$("> li",$guide);$.each($allItems,function(i){var matches=PageGuide.DIRECTION_REGEX.exec($(this).attr("class"));var direction=matches?matches.pop():that.settings.step.direction;var step={target:$(this).data("tourtarget"),content:$(this).html(),direction:direction,options:$.extend(true,{},$(this).data("options")),elem:this};guide.steps.push(step);});}else{$guide=((guide.id&&$("#"+guide.id).size())?$("#"+guide.id).empty():$("<ol/>",{id:guide.id||"pageGuide"+PageGuide.uid(),"class":"pageguide-guide"})).data("tourtitle",guide.title);$.each(guide.steps,function(i){var $li=$("<li/>",{id:"pageguide-step-"+i,"class":"pageguide-step pageguide-"+this.direction}).data("tourtarget",this.target);$li.data("options",$.extend({},this));$("<div/>",{"class":"pageguide-content"}).html(this.content).appendTo($li);$guide.append($li);this.elem=$li;});}this._guide=guide;this.curIdx=0;this.$wrapper.append($guide);this.$guide=$guide;this.$allItems=$("> li",this.$guide);this.$visibleItems=$();this.$toggle.removeClass(".pageguide-toggle-open").addClass("pageguide-toggle-close");this.$toggle.find(".pageguide-tourtitle").html(this._guide.title);$("body").addClass("pageguide-ready");this._registerGuideHandlers();this._registerCustomHandlers();this._registerCustomStepHandlers();this.status="loaded";this.$wrapper.trigger("load.pageguide",this._guide);return this;},unload:function(){if(!this._guide){return this;}if(this.isOpen()){this.close();}this.$toggle.removeClass("pageguide-toggle-open pageguide-toggle-close");$("body").removeClass("pageguide-ready");this._removeCustomStepHandlers();this._removeCustomHandlers();this._removeGuideHandlers();this.$allItems=$();this.$visibleItems=$();this.$guide=null;this._guide=null;this.settings=this.options();this.status="unloaded";this.$wrapper.trigger("unload.pageguide");return this;},open:function(){if($("body").is(".pageguide-open")){return;}$("body").addClass("pageguide-open");this._onExpand();this.$visibleItems.toggleClass("expanded",true);this.$wrapper.trigger("open.pageguide");this.$visibleItems.trigger("show.pageguide");return this;},close:function(){if(!$("body").is(".pageguide-open")){return this;}this.autoAdvance(false);this.$shadow.removeClass("pageguide-shadow-active").hide();this.$allItems.removeClass("pageguide-active").toggleClass("expanded",false);var curItem=this.$visibleItems[this.curIdx];if(curItem){$(curItem).trigger("deselect.pageguide");}this.$toggle.removeClass("pageguide-toggle-open").addClass("pageguide-toggle-close");this.$message.animate({height:"0"},500,function(){$(this).hide();});$("ins").remove();$("body").removeClass("pageguide-open");this.$visibleItems.trigger("hide.pageguide");this.$wrapper.trigger("close.pageguide");return this;},previous:function(){if(!$("body").is(".pageguide-open")){return this;}var newIdx=(this.curIdx+this.$visibleItems.size()-1)%this.$visibleItems.size();this.$wrapper.trigger("previous.pageguide");this.showStep(newIdx,1);return this;},next:function(){if(!$("body").is(".pageguide-open")){return this;}var newIdx=(this.curIdx+1)%this.$visibleItems.size();this.$wrapper.trigger("next.pageguide");this.showStep(newIdx,-1);return this;},showStep:function(newIdx,direction){var oldIdx=this.curIdx,oldItem=this.$visibleItems[oldIdx],newItem=this.$visibleItems[newIdx],left=(direction&&direction!==0)?(direction>0)?true:false:(oldIdx>newIdx),settings=$.extend(true,{},this.settings.step,$(newItem).data("options")||{});this.curIdx=newIdx;$("div",this.$message).html($(newItem).children("div").html());this.$visibleItems.removeClass("pageguide-active");$(newItem).addClass("pageguide-active");if(settings.shadow){this._showShadow(newItem);}else{this.$shadow.removeClass("pageguide-shadow-active").hide();}if(!this._isScrolledIntoView($(newItem))){this._scrollIntoView(newItem);}this.$message.not(":visible").show().animate({height:"100px"},500);this._rollNumber($("span",this.$message),$(newItem).children("ins").html(),left);this.$wrapper.trigger("step.pageguide",newItem);if($(oldItem).data("idx")!=$(newItem).data("idx")){$(oldItem).trigger("deselect.pageguide",newItem);}$(newItem).trigger("select.pageguide",oldItem);return this;},refresh:function(){if(!this.isOpen()){return this;}var that=this;this.$visibleItems=this.$allItems.filter(function(){return $($(this).data("tourtarget")).is(":visible");});this.$visibleItems.each(function(){var arrow=$(this),settings=$.extend(true,{},that.settings.step,$(this).data("options")||{}),target=$(arrow.data("tourtarget")),setLeft=target.offset().left+parseInt(settings.arrow.offsetX,10),setTop=target.offset().top+parseInt(settings.arrow.offsetY,10);if(arrow.hasClass("pageguide-top")){setTop-=60;}else{if(arrow.hasClass("pageguide-bottom")){setTop+=target.outerHeight()+15;}else{setTop+=5;}}if(arrow.hasClass("pageguide-right")){setLeft+=target.outerWidth(false)+15;}else{if(arrow.hasClass("pageguide-left")){setLeft-=65;}else{setLeft+=5;}}arrow.css({left:setLeft+"px",top:setTop+"px"});});if(this.$shadow.is(":visible")){this._showShadow(this.$visibleItems[this.curIdx],false);}return this;},autoAdvance:function(toggle){if(toggle===undefined||!!toggle){if(this.advanceTimer){return this;}this.advanceTimer=setInterval($.proxy(this.next,this),this.settings.autoAdvanceInterval*1000);}else{clearInterval(this.advanceTimer);this.advanceTimer=null;}return this;},isLoaded:function(){return !!this._guide;},isOpen:function(){return $("body").is(".pageguide-open");},_registerWrapperHandlers:function(){this.$toggle.on("click",$.proxy(function(e){if($("body").is(".pageguide-open")){this.close();}else{this.open();}},this));this.$message.on("click",".pageguide-close",$.proxy(function(e){this.close();},this));this.$message.on("click",".pageguide-index",$.proxy(function(e){e.stopPropagation();var item=this.$visibleItems[this.curIdx];if(!this._isScrolledIntoView(item)){this._scrollIntoView(item);}},this));this.$fwd.on("click",$.proxy(function(e){e.stopPropagation();this.autoAdvance(false);this.next();},this));this.$back.on("click",$.proxy(function(e){e.stopPropagation();this.autoAdvance(false);this.previous();},this));this.$shadow.on("animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd",".pageguide-shadow-pulse",function(){$(this).hide();});$(window).resize($.proxy(function(){this._onResize();},this));this.$wrapper.on("destroyed",$.proxy(this.destroy,this));},_removeWrapperHandlers:function(){this.$wrapper.off();this.$toggle.off();this.$message.off();this.$shadow.off();this.$fwd.off();this.$back.off();$(window).unbind("resize.pageguide");},_registerGuideHandlers:function(){if(!this.$guide){return false;}this.$guide.on("click","li",$.proxy(function(e){e.stopPropagation();var newIdx=$(e.currentTarget).data("idx");this.$wrapper.trigger("click.pageguide",newIdx);if(this.curIdx==newIdx){return;}this.showStep(newIdx);},this));},_removeGuideHandlers:function(){this.$guide.off();},_registerCustomHandlers:function(){var that=this,events=$.extend(true,{},this.settings.events,this._guide.events);if(!$.isEmptyObject(events)){$.each(events,function(i){that.$wrapper.on(i+".pageguide",this);});}},_removeCustomHandlers:function(){var that=this,events=$.extend(true,{},this.settings.events,this._guide.events);if(!$.isEmptyObject(events)){$.each(events,function(i){that.$wrapper.off(i+".pageguide",this);});}},_registerCustomStepHandlers:function(){var that=this;$.each(this._guide.steps,function(i){var $step=$(this.elem),settings=$.extend(true,{},that.settings.step,this);if($.isEmptyObject(settings.events)){return;}for(var j in settings.events){if(!settings.events.hasOwnProperty(j)){continue;}$step.on(j+".pageguide",settings.events[j]);}});},_removeCustomStepHandlers:function(){$.each(this.$allItems,function(i){$(this).off("click.pageguide, show.pageguide, hide.pageguide, select.pageguide, deselect.pageguide");});},_wait:function(callback){var that=this;var interval=window.setInterval(function(){if(!$(that.settings.loadingSelector).is(":visible")){callback();clearInterval(interval);}},250);},_rollNumber:function($numWrapper,newText,left){$numWrapper.animate({"text-indent":(left?"":"-")+"50px"},"fast",function(){$numWrapper.html(newText);$numWrapper.css({"text-indent":(left?"-":"")+"50px"},"fast").animate({"text-indent":"0"},"fast");});return this;},_scrollIntoView:function(elem){var $t=$(elem).data("tourtarget")?$($(elem).data("tourtarget")):$(elem),dvh=$(window).height(),msgh=this.$message.outerHeight(),elh=$t.outerHeight(),dvtop=$(window).scrollTop(),eltop=$t.offset().top,elbtm=eltop+elh,mgn=$(elem).data("options")?$.extend({},this.settings.step.margin,$(elem).data("options").margin||{}):this.settings.step.margin,mgnb=Math.max(mgn.bottom,msgh+15);var scrollTo=((eltop<=dvtop+mgn.top)||(elh>(dvh-mgnb)))?eltop-mgn.top:(elbtm-(dvh-mgnb));$("html,body").animate({scrollTop:scrollTo},{complete:$.proxy(this._onResize,this),duration:500});},_isScrolledIntoView:function(elem){var $t=$(elem).data("tourtarget")?$($(elem).data("tourtarget")):$(elem),msgh=this.$message.outerHeight(),dvtop=$(window).scrollTop(),dvbtm=dvtop+$(window).height(),eltop=$t.offset().top,elbtm=eltop+$t.outerHeight(),mgn=$(elem).data("options")?$.extend({},this.settings.step.margin,$(elem).data("options").margin||{}):this.settings.step.margin;return(eltop>=dvtop+mgn.top)&&(elbtm<=dvbtm-Math.max(mgn.bottom,msgh+15));},_onExpand:function(){this.refresh();this.curIdx=0;var that=this;this.$visibleItems.each(function(i){var settings=$.extend(true,{},that.settings.step,$(this).data("options")||{}),zIndex=settings.zIndex?settings.zIndex:$($(this).data("tourtarget")).zIndex()+2;$(this).css("z-index",zIndex);$(this).prepend("<ins>"+(i+1)+"</ins>");$(this).data("idx",i);});if((this.settings.autoAdvanceInterval||this.settings.autoStart)&&this.$visibleItems.size()>0){if(this.settings.autoStartDelay){setTimeout($.proxy(function(){this.showStep(0);},this),this.settings.autoStartDelay);}else{this.showStep(0);}}if(this.settings.autoAdvanceInterval){this.autoAdvance(true);}},_showShadow:function(elem,pulse){if(pulse===undefined){pulse=this.settings.pulse;}var $t=$(elem).data("tourtarget")?$($(elem).data("tourtarget")):$(elem),settings=$.extend(true,{},this.settings.step,$(elem).data("options")||{}),padding=settings.shadowPadding?parseInt(settings.shadowPadding,10):0,zIndex=$t.zIndex()+1,$pulse=this.$shadow.children(".pageguide-shadow-pulse");if(!!pulse){$pulse.hide();}this.$shadow.css({height:$t.outerHeight(),width:$t.outerWidth(false),padding:padding,top:$t.offset().top-padding,left:$t.offset().left-padding,zIndex:zIndex}).toggleClass("pageguide-shadow-active",true).show();if(!!pulse){$pulse.show();}return this;},_onResize:function(){if(!this.isOpen()){return this;}this.refresh();if($.debounce!==undefined){$.debounce($.proxy(function(){this.$wrapper.trigger("resize.pageguide");},300),this);}else{this.$wrapper.trigger("resize.pageguide");}},_zIndex:function(zIndex){if(zIndex!==undefined){return this.css("zIndex",zIndex);}if(this.length){var elem=$(this[0]),position,value;while(elem.length&&elem[0]!==document){position=elem.css("position");if(position=="absolute"||position=="relative"||position=="fixed"){value=parseInt(elem.css("zIndex"),10);if(!isNaN(value)&&value!==0){return value;}}elem=elem.parent();}}return 0;}}});var pg=null;$.pageguide=function(fn,options){if(arguments.length==0){return pg?pg:(pg=new PageGuide());}if(pg&&typeof pg[fn]=="function"){if(fn=="destroy"){pg.destroy();pg=null;return;}return pg[fn].apply(pg,Array.prototype.slice.call(arguments,1));}return pg?pg.load(fn,options):(pg=new PageGuide(fn,options));};}));
